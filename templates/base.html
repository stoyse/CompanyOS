<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    /* Header Styles */
    .topbar {
      height: 60px;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-bar input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      outline: none;
    }

    .profile-section {
      display: flex;
      align-items: center;
      position: relative;
      cursor: pointer;
    }

    .profile-section img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      overflow: hidden;
      z-index: 1000;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .dropdown-menu a:hover {
      background-color: #f4f4f9;
    }

    /* Notification Popup Styles */
    #notification-popup-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .notification-popup {
      background-color: #2d3748;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      min-width: 250px;
    }

    .notification-popup.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Notification Dropdown Styles */
    .notification-dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 50px;
      background-color: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      overflow: hidden;
      z-index: 1000;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      font-size: 0.9em;
      color: #333;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item strong {
      color: #007bff;
    }

    .notification-header {
      padding: 10px 15px;
      font-weight: bold;
      background-color: #f8f9fa;
      border-bottom: 1px solid #eee;
    }

    .no-notifications {
      padding: 15px;
      text-align: center;
      color: #6c757d;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 10px;
      display: none;
    }

    i {
      margin-left: 1vw;
      position: relative;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Header oben -->
  <div class="header">
    <div class="topbar">
      <div class="search-bar">
        <input type="text" placeholder="Search...">
      </div>
      <div class="profile-section">
        <img src="/api/avatar/{{ username }}" alt="Profile" onclick="toggleDropdown()">
        <span onclick="toggleDropdown()">{{ username }}</span>
        <i id="notification-bell" onclick="toggleNotificationDropdown()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
          </svg>
          <span id="notification-badge" class="notification-badge">0</span>
        </i>
        <div class="dropdown-menu" id="profileDropdown">
          <a href="/profile">View Profile</a>
          <a href="/settings">Settings</a>
          <a href="/logout" style="color: red;">Logout</a>
        </div>
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">Notifications</div>
          <div id="notification-list">
            <div class="no-notifications">No new notifications</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="flex h-screen">
    <div class="w-16 flex flex-col justify-between border-e border-gray-100 bg-white">
      <div>
        <div class="inline-flex size-16 items-center justify-center">
          <span class="grid size-10 place-content-center rounded-lg bg-gray-100 text-xs text-gray-600">
            L
          </span>
        </div>

        <div class="border-t border-gray-100">
          <div class="px-2">
            <div class="py-4">
              <a
                href="/ai"
                class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_ai %}text-gray-500 hover:bg-gray-50 hover:text-gray-700{% endblock %}"
                >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-2.25-1.313M21 7.5v2.25m0-2.25-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3 2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75 2.25-1.313M12 21.75V19.5m0 2.25-2.25-1.313m0-16.875L12 2.25l2.25 1.313M21 14.25v2.25l-2.25 1.313m-13.5 0L3 16.5v-2.25" />
                  </svg>
                  

                <span
                  class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                >
                  AI
                </span>
              </a>
            </div>

            <ul class="space-y-1 border-t border-gray-100 pt-4">
              <li>
                <a
                  href="/"
                  class="t group relative flex justify-center rounded-sm {% block sidebar_home %}bg-blue-50 text-blue-700{% endblock %} px-2 py-1.5"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="size-5 opacity-75"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
                    />
                  </svg>

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Dashboard
                  </span>
                </a>
              </li>
              <li>
                <a
                  href="/tasks"
                  class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_tasks %}text-gray-500 hover:bg-gray-50 hover:text-gray-700{% endblock %}"
                >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 6.878V6a2.25 2.25 0 0 1 2.25-2.25h7.5A2.25 2.25 0 0 1 18 6v.878m-12 0c.235-.083.487-.128.75-.128h10.5c.263 0 .515.045.75.128m-12 0A2.25 2.25 0 0 0 4.5 9v.878m13.5-3A2.25 2.25 0 0 1 19.5 9v.878m0 0a2.246 2.246 0 0 0-.75-.128H5.25c-.263 0-.515.045-.75.128m15 0A2.25 2.25 0 0 1 21 12v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6c0-.98.626-1.813 1.5-2.122" />
                </svg>
                

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Tasks
                  </span>
                </a>
              </li>
              <li>
                <a
                  href="/team"
                  class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_team %}bg-blue-50 text-blue-700{% endblock %}"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="size-5 opacity-75"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"
                    />
                  </svg>

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Teams
                  </span>
                </a>
              </li>
              <li>
                <a
                  href="calendar"
                  class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_calendar %}text-gray-500 hover:bg-gray-50 hover:text-gray-700{% endblock %}"
                >
                
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 2.994v2.25m10.5-2.25v2.25m-14.252 13.5V7.491a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v11.251m-18 0a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5m-6.75-6h2.25m-9 2.25h4.5m.002-2.25h.005v.006H12v-.006Zm-.001 4.5h.006v.006h-.006v-.005Zm-2.25.001h.005v.006H9.75v-.006Zm-2.25 0h.005v.005h-.006v-.005Zm6.75-2.247h.005v.005h-.005v-.005Zm0 2.247h.006v.006h-.006v-.006Zm2.25-2.248h.006V15H16.5v-.005Z" />
                  </svg>

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Calendar
                  </span>
                </a>
              </li>

              <li>
                <a
                  href="/projects"
                  class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_projects %}text-gray-500 hover:bg-gray-50 hover:text-gray-700{% endblock %}"
                >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                </svg>
                

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Projects
                  </span>
                </a>
              </li>

              <li>
                <a
                  href="/reports"
                  class="group relative flex justify-center rounded-sm px-2 py-1.5 {% block sidebar_reports %}text-gray-500 hover:bg-gray-50 hover:text-gray-700{% endblock %}
                  "
                >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125-1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg>
                

                  <span
                    class="invisible absolute start-full top-1/2 ms-4 -translate-y-1/2 rounded-sm bg-gray-900 px-2 py-1.5 text-xs font-medium text-white group-hover:visible"
                  >
                    Reports
                  </span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-4">
      {% block content %}
      <!-- Child templates will override this block -->
      {% endblock %}
    </div>
  </div>

  <!-- Container für Benachrichtigungs-Popups -->
  <div id="notification-popup-container"></div>

  <script>
    function toggleDropdown() {
      const dropdown = document.getElementById('profileDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      document.getElementById('notificationDropdown').style.display = 'none';
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      document.getElementById('profileDropdown').style.display = 'none';
    }

    document.addEventListener('click', function(event) {
      const profileDropdown = document.getElementById('profileDropdown');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const profileSection = document.querySelector('.profile-section');
      if (!profileSection.contains(event.target)) {
        profileDropdown.style.display = 'none';
        notificationDropdown.style.display = 'none';
      }
    });

    const notificationPopupContainer = document.getElementById('notification-popup-container');
    const notificationList = document.getElementById('notification-list');
    const noNotificationsMessage = notificationList.querySelector('.no-notifications');
    const notificationBadge = document.getElementById('notification-badge');
    let notificationCount = 0;

    // Funktion zum Anzeigen eines Popups
    function showNotificationPopup(sender, messageSnippet, messageType) {
        const popup = document.createElement('div');
        popup.className = 'notification-popup';
        let contentHtml = `<strong>${sender}</strong> `;
        if (messageType === 'file') {
            contentHtml += `sent you a file:<br>📄 ${messageSnippet}`; // Zeige Dateinamen
        } else {
            contentHtml += `sent you a message:<br>${messageSnippet}`;
        }
        popup.innerHTML = contentHtml;
        notificationPopupContainer.appendChild(popup);

        setTimeout(() => popup.classList.add('show'), 10);

        setTimeout(() => {
            popup.classList.remove('show');
            setTimeout(() => popup.remove(), 500);
        }, 5000);
    }

    // Funktion zum Hinzufügen zur Benachrichtigungsliste
    function addNotificationToList(sender, messageSnippet, messageType) {
        if (noNotificationsMessage) {
            noNotificationsMessage.style.display = 'none';
        }

        const listItem = document.createElement('div');
        listItem.className = 'notification-item';
        let contentHtml = `<strong>${sender}:</strong> `;
         if (messageType === 'file') {
            contentHtml += `[File] ${messageSnippet}`; // Zeige Dateinamen
        } else {
            contentHtml += messageSnippet;
        }
        listItem.innerHTML = contentHtml;
        notificationList.insertBefore(listItem, notificationList.firstChild);

        updateNotificationBadge(++notificationCount);
    }

    function updateNotificationBadge(count) {
      notificationBadge.textContent = count;
      notificationBadge.style.display = count > 0 ? 'block' : 'none';
    }

    {% if username %}
    const socket = io();

    socket.on('connect', () => {
      console.log('Socket.IO connected for notifications');
      // socket.emit('join_room', '{{ username }}'); // Wird jetzt in app.py beim connect gemacht
    });

    socket.on('disconnect', () => {
      console.log('Socket.IO disconnected');
    });

    socket.on('new_message_notification', (data) => {
      console.log('Notification received:', data);
      // Übergebe message_type an die Funktionen
      showNotificationPopup(data.sender, data.message_snippet, data.message_type);
      addNotificationToList(data.sender, data.message_snippet, data.message_type);
    });

    updateNotificationBadge(notificationCount);
    {% endif %}
  </script>
</body>
</html>